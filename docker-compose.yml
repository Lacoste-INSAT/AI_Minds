###############################################################################
# Synapsis — Docker Compose
# Qdrant vector store + Backend API (with file observer)
###############################################################################

services:
  # ---------------------------------------------------------------------------
  # Qdrant — Vector Search Engine
  # ---------------------------------------------------------------------------
  qdrant:
    image: qdrant/qdrant:latest
    container_name: synapsis-qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"   # REST API
      - "6334:6334"   # gRPC
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__LOG_LEVEL=INFO
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:6333/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ---------------------------------------------------------------------------
  # Synapsis Backend + File Observer
  # ---------------------------------------------------------------------------
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: synapsis-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - ./data:/app/data
      - ./config:/app/config
      # Mount host directories to watch inside the container.
      # Add/change paths below to match your system.
      # Linux/macOS:
      #   - ~/Documents:/app/watched/Documents
      #   - ~/Desktop:/app/watched/Desktop
      #   - ~/Downloads:/app/watched/Downloads
      # Windows (use full paths):
      #   - C:/Users/YourName/Documents:/app/watched/Documents
      #   - C:/Users/YourName/Desktop:/app/watched/Desktop
      #   - C:/Users/YourName/Downloads:/app/watched/Downloads
      - ./data/sample_knowledge:/app/watched/sample_knowledge
    environment:
      - SYNAPSIS_QDRANT_HOST=qdrant
      - SYNAPSIS_QDRANT_PORT=6333
      - SYNAPSIS_OLLAMA_BASE_URL=http://host.docker.internal:11434
      - SYNAPSIS_HOST=0.0.0.0
      # Watched directories inside the container (comma-separated)
      - SYNAPSIS_WATCHED_DIRECTORIES=["/app/watched/sample_knowledge"]
    depends_on:
      qdrant:
        condition: service_healthy

volumes:
  qdrant_data:
    driver: local
